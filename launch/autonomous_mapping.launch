<launch>

    <!--
        This launch file spins up the node that creates the occupancy grid consumed by the planning subsystem. Note that it
        requires odometry (currently stereo odometry, but could be /ekf/Odometry/local) and rectified stereo images; these are
        provided by "stereo_odometry.launch" (which is launched automatically when this file is launched).
    -->

    <!-- switch to "true" for rviz -->
    <arg name="rviz" default="true" />
    <node if="$(arg rviz)" pkg="rviz" type="rviz" name="rviz" args="-d $(find core_rover)/launch/config/nova_stereo_outdoor.rviz"/>

    <!-- launch "stereo_odometry.launch" for odometry and rectified stereo images -->
    <include file="$(find core_rover)/launch/stereo_odometry.launch"/>

    <group ns="rtabmap">
        <node name="rtabmap" pkg="rtabmap_ros" type="rtabmap" output="screen" args="--delete_db_on_start">
            <param name="approx_sync" value="true"/>

            <!-- SUBSCRIBE to: odometry (either "/stereo_odometry" or "/ekf/Odometry/local") -->
            <remap from="odom" to="/stereo_odometry"/>

            <!-- SUBSCRIBE to: rectified stereo images -->
            <param name="subscribe_stereo" type="bool" value="true"/>
            <param name="subscribe_rgb" type="bool" value="false"/>
            <param name="subscribe_depth" type="bool" value="false"/> <!-- this is required for mono cameras -->
            <remap from="left/image_rect" to="/elp/left/image_rect_color"/> <!-- for some reason, left has to be RGB or mono-->
            <remap from="right/image_rect" to="/elp/right/image_rect"/>
            <remap from="left/camera_info" to="/elp/left/camera_info"/>
            <remap from="right/camera_info" to="/elp/right/camera_info"/>

            <!-- SUBSCRIBE to: lidar -->
            <!-- commented-out, could not get lidar to work alongside stereo
            <param name="subscribe_scan_cloud" value="true"/>
            <remap from="scan_cloud" to="/ptcloud_merge"/>
            -->

            <!-- PUBLISH to: rtabmap occupancy grid -->
            
            <!-- PUBLISH: map->odom transform -->
            <param name="publish_tf" type="bool" value="true"/>

            <param name="frame_id" type="string" value="base_link"/>

            <!-- other params -->
            <!-- Grid Map Params-->
            <param name="Grid/MinSize" value="0.0"/>
            <param name="Grid/Eroded" value="false"/>
            <param name="Grid/Scan2dUnknownSpaceFilled" type="bool" value="false"/>

            <!-- Map Projection Params -->
            <param name="Grid/NormalsSegmentation" value="true"/>
            <param name="Grid/MaxGroundAngle" value="45"/>
            <param name="Grid/MinClusterSize" value="20"/>
            <param name="Grid/MaxGroundHeight" value="0.2"/>
            <param name="Grid/MinGroundHeight" value="-0.2"/>
            <param name="Grid/FootprintLength" value="1.0"/>
            <param name="Grid/FootprintWidth" value="1.0"/>
            <param name="Grid/DepthDecimation" type="string" value="4"/>

            <!-- RTAB-Map's parameters -->
            <param name="Rtabmap/TimeThr" type="string" value="700"/>
            <param name="Rtabmap/DetectionRate" type="string" value="1"/>
            <param name="Kp/MaxDepth" type="string" value="10"/>
            <param name="Kp/DetectorStrategy" type="string" value="6"/>
            <param name="Vis/EstimationType"  type="string" value="1"/>
            <param name="Vis/MaxDepth" type="string" value="10"/>  
        </node>
    </group>

</launch>
